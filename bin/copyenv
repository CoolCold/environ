#!/bin/bash

# this script gonna copy my environment to remote server

PROGNAME=$(basename $0)
AKEY_TMPL="~/.ssh/authorized_keys"
AKEY_FILE=$(eval echo "$AKEY_TMPL")
DEFAULT_AUTHCOPY=NO
RHOST=""

ENVFILE=".envversion.txt"

# Nested config files: source and destination (both relative to homedir)
NESTED_CONFIG_SRC=(".config/starship.toml" ".config/nvim/init.vim")
NESTED_CONFIG_DST=(".config/starship.toml" ".config/nvim/init.vim")

print_usage() {
    echo "Usage: $PROGNAME [-A] -H hostname"
    echo ""
    echo "-A enables authorized_keys copy (with overwrite), default: $DEFAULT_AUTHCOPY"
    echo ""
    echo "-H sets the hostname where should data be copied to"
}

print_help() {
    echo "$PROGNAME"
    echo ""
    print_usage
    echo ""
    echo "This script will copy my (and may be even your) environment to remote host"
}


if [ -z "$1" ];then
	echo "no params were specified, use \"$0 -h\" to obtain help"
    echo ""
    print_help
    exit 2
fi

AUTHCOPY=$DEFAULT_AUTHCOPY

while getopts ":hAH:" Option; do
  case $Option in
    h)
      print_help
      exit 0
      ;;
    H)
      RHOST=${OPTARG}
      ;;
    A)
      AUTHCOPY="YES"
      ;;
    *)
      print_help
      exit 2
      ;;
  esac
done
shift $((OPTIND - 1))

if [ -z "$RHOST" ];then
    echo "hostname is not set!"
    print_help
    exit 2
fi

akey=""
cd ~ || exit 2
if [ "$AUTHCOPY" == "YES" ];then
    echo "copying $AKEY_FILE"
    if akey=$(cat "$AKEY_FILE") && [ -n "$akey" ];then
        ssh "$RHOST" "mkdir -p ~/.ssh; chmod 700 ~/.ssh; echo '${akey}' > ~/.ssh/authorized_keys; chmod 600 ~/.ssh/authorized_keys"
    else
        echo "$AKEY_FILE wasn't copied - empty/unable to read, skipping"
    fi
fi
scp -r bin .vimrc .vim .screenrc .profile .bash_profile .bashrc .gitconfig .hgrc .tmux.conf .inputrc "${ENVFILE}" "$RHOST":

# Phase 2: Nested configs - ensure dirs exist on remote, then copy
if [ ${#NESTED_CONFIG_SRC[@]} -gt 0 ]; then
    # Create all parent directories in one ssh call
    dir_cmd=""
    for dst in "${NESTED_CONFIG_DST[@]}"; do
        dir=$(dirname "$dst")
        dir_cmd="${dir_cmd} install -d ~/${dir};"
    done
    # shellcheck disable=SC2029
    ssh "$RHOST" "$dir_cmd"
    
    # Copy each nested file
    for i in "${!NESTED_CONFIG_SRC[@]}"; do
        src="${NESTED_CONFIG_SRC[$i]}"
        dst="${NESTED_CONFIG_DST[$i]}"
        scp -r "$src" "$RHOST:$dst"
    done
fi
